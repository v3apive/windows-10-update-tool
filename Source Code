# -*- coding: utf-8 -*-
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import threading, os, requests, subprocess, ctypes, string, webbrowser, shutil

# –ü—É—Ç–∏
d = os.path.join(os.path.expanduser("~"), "Desktop")
iso = os.path.join(d, "Windows.iso")
out = os.path.join(d, "Win10_Pack")

def is_admin():
    try: return ctypes.windll.shell32.IsUserAnAdmin()
    except: return False

def check_space_manual():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    total, used, free = shutil.disk_usage("C:\\")
    free_gb = free // (2**30)
    if free_gb < 15:
        messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", f"–°–≤–æ–±–æ–¥–Ω–æ: {free_gb} –ì–ë.\n–≠—Ç–æ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ–≤–∞—Ç–æ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –¥–æ 20-25 –ì–ë.")
    else:
        messagebox.showinfo("–ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ", f"–ù–∞ –¥–∏—Å–∫–µ C: —Å–≤–æ–±–æ–¥–Ω–æ {free_gb} –ì–ë.\n–ú–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!")

def check_space_auto(required_gb=10):
    """–¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏—è–º–∏"""
    total, used, free = shutil.disk_usage("C:\\")
    free_gb = free // (2**30)
    if free_gb < required_gb:
        messagebox.showwarning("–ú–∞–ª–æ –º–µ—Å—Ç–∞", f"–ù–∞ –¥–∏—Å–∫–µ C: –≤—Å–µ–≥–æ {free_gb} –ì–ë.\n–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º {required_gb} –ì–ë.")
        return False
    return True

def get_7z(): webbrowser.open("https://www.7-zip.org/")

def pick():
    global iso
    p = filedialog.askopenfilename(title="–í—ã–±–æ—Ä ISO", filetypes=[("ISO", "*.iso")])
    if p:
        iso = p
        lbl_p.config(text="–§–∞–π–ª: " + os.path.basename(iso), fg="green")

def dl():
    u = "https://dn710004.ca.archive.org/0/items/windows-10-22-h-2-russian-x-64/Windows%2010%2022H2%20%28Russian%29%20x64.iso"
    def r():
        try:
            if not check_space_auto(8): return
            lbl_p.config(text="–ó–∞–≥—Ä—É–∑–∫–∞...", fg="blue")
            res = requests.get(u, stream=True, timeout=60)
            tot = int(res.headers.get("content-length", 0))
            pb.configure(mode="determinate", maximum=100)
            cur = 0
            with open(iso, "wb") as f:
                for c in res.iter_content(chunk_size=1024*1024):
                    if c:
                        f.write(c); cur += len(c)
                        p = int((cur / tot) * 100)
                        root.after(0, lambda v=p: pb.configure(value=v))
                        root.after(0, lambda v=p: lbl_p.config(text="–ó–∞–≥—Ä—É–∑–∫–∞: "+str(v)+"%"))
            messagebox.showinfo("–û–ö", "ISO —Å–∫–∞—á–∞–Ω –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª!")
        except Exception as e: messagebox.showerror("–û—à–∏–±–∫–∞", str(e))
    threading.Thread(target=r, daemon=True).start()

def mount():
    if not os.path.exists(iso): return messagebox.showerror("!", "–°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ ISO!")
    try:
        subprocess.run(["powershell", "-Command", 'Mount-DiskImage -ImagePath "'+iso+'"'], shell=True)
        lbl_p.config(text="–ü—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ!", fg="green")
        messagebox.showinfo("OK", "–î–∏—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω. –¢–µ–ø–µ—Ä—å –∂–º–∏—Ç–µ –®–ê–ì 3.")
    except: messagebox.showerror("!", "–í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.")

def unpack():
    if not os.path.exists(iso): return messagebox.showerror("!", "–°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ ISO!")
    if not check_space_auto(12): return
    if not os.path.exists(out): os.makedirs(out)
    def r():
        try:
            lbl_p.config(text="–ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...", fg="orange")
            ps = 'Mount-DiskImage -ImagePath "'+iso+'" -PassThru | Get-Volume | Select-Object -ExpandProperty DriveLetter'
            dr = subprocess.check_output(["powershell", "-Command", ps]).decode("utf-8").strip()
            if not dr: raise Exception("Err")
            lbl_p.config(text="–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ (Robocopy)...", fg="blue")
            pb.configure(mode="indeterminate"); pb.start(10)
            subprocess.run(['robocopy', dr+":\\", out, '/E', '/MT:8', '/R:0', '/W:0', '/NFL', '/NDL'], shell=True)
            pb.stop(); pb.configure(mode="determinate", value=100)
            subprocess.run(["powershell", "-Command", 'Dismount-DiskImage -ImagePath "'+iso+'"'], shell=True)
            lbl_p.config(text="–ì–æ—Ç–æ–≤–æ! –ü–∞–ø–∫–∞ Win10_Pack —Å–æ–∑–¥–∞–Ω–∞.", fg="green"); os.startfile(out)
        except: 
            pb.stop()
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–ê–≤—Ç–æ-—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 7-Zip.")
    threading.Thread(target=r, daemon=True).start()

def run_upd():
    e = os.path.join(out, "setup.exe")
    if os.path.exists(e): subprocess.Popen(e, shell=True)
    else:
        for l in string.ascii_uppercase:
            if os.path.exists(l+":\\setup.exe"): subprocess.Popen(l+":\\setup.exe", shell=True); return
        messagebox.showerror("!", "setup.exe –Ω–µ –Ω–∞–π–¥–µ–Ω! –†–∞—Å–ø–∞–∫—É–π—Ç–µ ISO.")

# --- –ò–ù–¢–ï–†–§–ï–ô–° ---
root = tk.Tk()
root.title("Windows 10 Update Tool version 41.2")
root.geometry("520x980")
try: root.iconbitmap("icon.ico")
except: pass

f = tk.Frame(root, padx=15, pady=10); f.pack(fill="both")
tk.Label(f, text="Windows 10 Update Tool", font=("Arial", 16, "bold")).pack(pady=5)
tk.Label(f, text="–ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫ Windows 10", font=("Arial", 10)).pack()

pb = ttk.Progressbar(f, length=450, mode="determinate"); pb.pack(pady=10)
lbl_p = tk.Label(f, text="–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π"); lbl_p.pack()

# –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ü–†–û–í–ï–†–ö–ò
ttk.Button(f, text="üìä –ü–†–û–í–ï–†–ò–¢–¨ –ú–ï–°–¢–û –ù–ê –î–ò–°–ö–ï C:", command=check_space_manual).pack(fill="x", pady=10)

ttk.Button(f, text="1. –°–ö–ê–ß–ê–¢–¨ ISO –û–ë–†–ê–ó", command=dl).pack(fill="x", pady=5)
ttk.Button(f, text="üìÇ –í–´–ë–†–ê–¢–¨ ISO –í–†–£–ß–ù–£–Æ", command=pick).pack(fill="x", pady=2)

m_f = tk.LabelFrame(f, text=" –°–ø–æ—Å–æ–± –¥–ª—è Windows 8 / 10 ", padx=10, pady=10, fg="blue")
m_f.pack(fill="x", pady=10)
ttk.Button(m_f, text="–®–ê–ì 2: –ú–û–ù–¢–ò–†–û–í–ê–¢–¨ –û–ë–†–ê–ó", command=mount).pack(fill="x", pady=5)

u_f = tk.LabelFrame(f, text=" –°–ø–æ—Å–æ–± –¥–ª—è Windows 7 ", padx=10, pady=10, fg="orange")
u_f.pack(fill="x", pady=10)
ttk.Button(u_f, text="–®–ê–ì 2: –†–ê–°–ü–ê–ö–û–í–ê–¢–¨ –í –ü–ê–ü–ö–£", command=unpack).pack(fill="x", pady=5)

tk.Button(f, text="–®–ê–ì 3: –ó–ê–ü–£–°–¢–ò–¢–¨ –û–ë–ù–û–í–õ–ï–ù–ò–ï", bg="green", fg="white", font=("Arial", 11, "bold"), command=run_upd).pack(fill="x", pady=15, ipady=8)

warn_f = tk.Frame(f, padx=10, pady=10, highlightbackground="gray", highlightthickness=1)
warn_f.pack(fill="x", pady=5)
warn_txt = ("–í–ù–ò–ú–ê–ù–ò–ï: –û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å Internet Archive.\n"
            "–î–∞–Ω–Ω—ã–π ISO –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –ü–û. –í –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–µ\n"
            "–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–µ–¥–∞–∫—Ü–∏–∏: —É–¥–∞–ª–µ–Ω—ã –ª–∏—à–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã\n"
            "–¥–ª—è —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –≤–µ—Ä—Å–∏–∏ '–î–ª—è –æ–¥–Ω–æ–≥–æ —è–∑—ã–∫–∞'.")
tk.Label(warn_f, text=warn_txt, justify="left", font=("Arial", 8, "italic"), fg="#555").pack()

p_f = tk.LabelFrame(f, text=" –ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å–ø–∞–∫–æ–≤–∫–æ–π? ", padx=10, pady=5, fg="red")
p_f.pack(fill="x", pady=10)
ttk.Button(p_f, text="–°–ö–ê–ß–ê–¢–¨ 7-ZIP", command=get_7z).pack(pady=5)

adm = "–û–ö" if is_admin() else "–¢–†–ï–ë–£–Æ–¢–°–Ø –ü–†–ê–í–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê!"
tk.Label(f, text="–°–¢–ê–¢–£–° –ü–†–ê–í: "+adm, fg=("green" if is_admin() else "red"), font=("Arial", 8, "bold")).pack(side="bottom")

root.mainloop()
