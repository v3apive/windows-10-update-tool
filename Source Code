#Region ; **** Directives created by AutoIt3Wrapper_GUI ****
#AutoIt3Wrapper_Icon=shell32.dll|-155
#AutoIt3Wrapper_Outfile=Win10_Ultimate_Deployer_Final.exe
#AutoIt3Wrapper_Res_RequestedExecutionLevel=highestAvailable
#EndRegion ; **** End of Directives ****

#RequireAdmin
#include <ButtonConstants.au3>
#include <GUIConstantsEx.au3>
#include <ProgressConstants.au3>
#include <StaticConstants.au3>
#include <WindowsConstants.au3>
#include <File.au3>

; --- CONFIG ---
Global $ISO_URL = "https://archive.org/download/windows-10-22-h-2-russian-x-64/Windows%2010%2022H2%20(Russian)%20x64.iso"
Global $ISO_PATH = ""
Global $EXTRACT_DIR = @DesktopDir & "\Win10_Files"

; --- UI ---
$hGUI = GUICreate("Win10 Universal Deployer", 450, 780) ; Чуть увеличил высоту для новой кнопки
GUISetBkColor(0xF0F0F0)

GUICtrlCreateLabel("Windows 10 Setup Tool", 10, 20, 430, 30, $SS_CENTER)
GUICtrlSetFont(-1, 16, 800)

; Группа 1: Подготовка
GUICtrlCreateGroup(" Step 1: ISO Preparation ", 15, 60, 420, 110)
$btnDown = GUICtrlCreateButton("DOWNLOAD ISO (Auto)", 35, 85, 380, 35)
$btnSelect = GUICtrlCreateButton("SELECT ISO MANUALLY", 35, 125, 380, 35)
GUICtrlCreateGroup("", -99, -99, 1, 1)

$progress = GUICtrlCreateProgress(15, 180, 420, 20)

; Группа 2: Для Windows 7
GUICtrlCreateGroup(" Windows 7 Fixes (STRICT NO IE) ", 15, 215, 420, 160)
GUICtrlSetColor(-1, 0xFF0000)
$btnScan = GUICtrlCreateButton("SCAN DISKS FOR ISO", 35, 240, 380, 35)
$btnBrowser = GUICtrlCreateButton("DEEP SEARCH BROWSERS & DOWNLOAD", 35, 280, 380, 35)
$btnCheckSpace = GUICtrlCreateButton("CHECK C: DRIVE SPACE", 35, 325, 380, 35)
GUICtrlCreateGroup("", -99, -99, 1, 1)

; Группа 3: Открытие образа
GUICtrlCreateGroup(" Step 2: Open Image ", 15, 390, 420, 110)
$btnMount = GUICtrlCreateButton("MOUNT ISO (Win 8+)", 35, 415, 380, 35)
$btnExtract = GUICtrlCreateButton("EXTRACT TO FOLDER", 35, 455, 380, 40)
GUICtrlCreateGroup("", -99, -99, 1, 1)

; Группа 4: ЗАПУСК (Раздельный)
GUICtrlCreateGroup(" Step 3: Start Installation ", 15, 515, 420, 160)
$btnRunFolder = GUICtrlCreateButton("RUN FROM EXTRACTED FOLDER (Win 7)", 35, 540, 380, 50)
GUICtrlSetFont(-1, 10, 800)
GUICtrlSetBkColor(-1, 0x90EE90) ; Светло-зеленый

$btnRunMount = GUICtrlCreateButton("RUN FROM MOUNTED DRIVE (Win 8/10)", 35, 605, 380, 50)
GUICtrlSetFont(-1, 10, 800)
GUICtrlSetBkColor(-1, 0x00FF00) ; Ярко-зеленый
GUICtrlCreateGroup("", -99, -99, 1, 1)

$Status = GUICtrlCreateLabel("Status: Ready", 10, 690, 430, 25, $SS_CENTER)
GUICtrlSetFont(-1, 10, 600)

GUISetState(@SW_SHOW)

; --- LOGIC ---
While 1
    Switch GUIGetMsg()
        Case $GUI_EVENT_CLOSE
            Exit
        Case $btnDown
            _DoDownload()
        Case $btnSelect
            _DoManualSelect()
        Case $btnScan
            _ScanDrives()
        Case $btnBrowser
            _ForceModernBrowser()
        Case $btnCheckSpace
            _CheckDiskSpace()
        Case $btnMount
            _DoMount()
        Case $btnExtract
            _DoExtract()
        Case $btnRunFolder
            _StartFromFolder()
        Case $btnRunMount
            _StartFromMount()
    EndSwitch
WEnd

; --- ФУНКЦИИ ЗАПУСКА ---

Func _StartFromFolder()
    If FileExists($EXTRACT_DIR & "\setup.exe") Then
        GUICtrlSetData($Status, "Status: Starting Setup from Folder...")
        ShellExecute($EXTRACT_DIR & "\setup.exe")
    Else
        MsgBox(48, "Error", "Папка с файлами не найдена! Сначала нажмите EXTRACT.")
    EndIf
EndFunc

Func _StartFromMount()
    Local $aDrives = DriveGetDrive("CDROM")
    Local $found = False
    If Not @error Then
        For $i = 1 To $aDrives[0]
            If FileExists($aDrives[$i] & "\setup.exe") Then
                GUICtrlSetData($Status, "Status: Starting from Drive " & StringUpper($aDrives[$i]))
                ShellExecute($aDrives[$i] & "\setup.exe")
                $found = True
                ExitLoop
            EndIf
        Next
    EndIf

    If Not $found Then
        MsgBox(48, "Error", "Смонтированный диск не найден! Сначала нажмите MOUNT (только для Win 8+).")
    EndIf
EndFunc

; --- ВСЕ ОСТАЛЬНЫЕ ФУНКЦИИ (БЕЗ ИЗМЕНЕНИЙ) ---

Func _DoManualSelect()
    Local $f = FileOpenDialog("Select ISO", @HomeDrive, "ISO Files (*.iso)")
    If Not @error Then
        $ISO_PATH = $f
        GUICtrlSetData($Status, "Status: ISO Selected: " & StringRegExpReplace($f, "^.*\\", ""))
    EndIf
EndFunc

Func _DoMount()
    If StringInStr(@OSVersion, "WIN_7") Then Return MsgBox(48, "Win 7", "Mount not supported on Win 7!")
    If $ISO_PATH = "" Or Not FileExists($ISO_PATH) Then Return MsgBox(48, "Error", "ISO file not selected!")
    ShellExecute($ISO_PATH)
EndFunc

Func _ForceModernBrowser()
    GUICtrlSetData($Status, "Status: Searching for browsers...")
    Local $aB[9] = ["chrome.exe", "firefox.exe", "supermium.exe", "opera.exe", "browser.exe", "vivaldi.exe", "brave.exe", "msedge.exe", "thorium.exe"]
    Local $found = False
    For $b In $aB
        Local $r = RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\" & $b, "")
        If $r <> "" And FileExists($r) And Not StringInStr($r, "iexplore.exe") Then
            ShellExecute($r, $ISO_URL)
            $found = True
            ExitLoop
        EndIf
    Next
    If Not $found Then ClipPut($ISO_URL)
    GUICtrlSetData($Status, $found ? "Status: Browser opened" : "Status: Link copied")
EndFunc

Func _ScanDrives()
    GUICtrlSetData($Status, "Status: Scanning...")
    Local $aD = DriveGetDrive("FIXED")
    Local $f = ""
    For $i = 1 To $aD[0]
        Local $h = FileFindFirstFile($aD[$i] & "\*Windows*10*.iso")
        If $h <> -1 Then
            $f = $aD[$i] & "\" & FileFindNextFile($h)
            FileClose($h)
            ExitLoop
        EndIf
    Next
    If $f <> "" Then
        $ISO_PATH = $f
        GUICtrlSetData($Status, "Status: ISO Linked!")
    EndIf
EndFunc

Func _CheckDiskSpace()
    Local $free = Round(DriveSpaceFree("C:\") / 1024, 2)
    MsgBox(64, "Space", "C: Drive has " & $free & " GB free")
EndFunc

Func _DoDownload()
    GUICtrlSetData($Status, "Status: Downloading...")
    InetGet($ISO_URL, @DesktopDir & "\Win10_Setup.iso", 1, 0)
    $ISO_PATH = @DesktopDir & "\Win10_Setup.iso"
    GUICtrlSetData($Status, "Status: ISO Ready on Desktop!")
EndFunc

Func _DoExtract()
    Local $7z = _Find7z()
    If $7z = "" Then Return MsgBox(16, "Error", "Install 7-Zip/WinRAR!")
    DirCreate($EXTRACT_DIR)
    RunWait('"' & $7z & '" x "' & $ISO_PATH & '" -o"' & $EXTRACT_DIR & '" -y')
    GUICtrlSetData($Status, "Status: Extracted!")
EndFunc

Func _Find7z()
    Local $p[4] = [@ProgramFilesDir & "\7-Zip\7z.exe", "C:\Program Files (x86)\7-Zip\7z.exe", @ProgramFilesDir & "\WinRAR\WinRAR.exe", "C:\Program Files (x86)\WinRAR\WinRAR.exe"]
    For $i = 0 To 3
        If FileExists($p[$i]) Then Return $p[$i]
    Next
    Return ""
EndFunc
